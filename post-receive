#!/bin/sh

tempfile=$(mktemp)
name=$(basename $(readlink -f $(dirname $(dirname $0))))
git_tools=$(dirname $(readlink -f $0))
cat | tee $tempfile | `dirname $0`/post-receive-email
cd /tmp/
export PATH=.:$PATH
export RTCONFIG=/usr/local/ass/configs/svn/rtrc
if [ ! -d $name ]; then
    git clone -q /git/$name
else
    cd $name
    git pull -q
fi
while read oldrev newrev refname; do
    branch=$(basename $refname)
    if [ -f .git/refs/remotes/origin/$branch ]; then # it's a branch
        if [ -f .git/refs/heads/$i ]; then
            git checkout $i
            git pull
        else
            git checkout -b $i origin/$i
        fi
        if echo $i | grep -q ^release_; then
            $git_tools/rt/RT-close.pl --close
        else
            $git_tools/rt/RT-close.pl --pending
        fi
    else # it's a tag
        git branch -D temptag || true
        git checkout -b temptag $i
        $git_tools/rt/RT-close.pl --close
    fi
done < $tempfile
rm $tempfile
